function Confirm-PrintSpoolerVulnerable {

    ## PSv2 does not support needed cmdlets
    if ((Get-Host).version.major -eq 2) {
        throw "PowerShell-version is too old to run script (2.0)"
    }

    ## See if spooler service is "running"
    $PrintSpoolerService = Get-Service -Name Spooler

    if ($PrintSpoolerService.Status -eq 4) {
        $SpoolerIsRunning = $True 
    }
    else {
        $SpoolerIsRunning = $False
    }

    ## See if print services / print management is installed on server
    try {
        $PrintMgmt = Get-WindowsFeature -Name Print-Services
    }
    catch {
        $PrintMgmt = $False
    }

    if ($PrintMgmt.InstallState -eq "Installed") {
        $PrintMgmtInstalled = $true
    }
    else {
        $PrintMgmtInstalled = $false
    }
    
    ## Also see if there are any shared printers on the server, in case print mgmt is not used for this
    try {
        if ((Get-Printer -ea stop).Shared -eq $true) {
            $PrintMgmtInstalled = $true
        }
    }
    catch {
        throw "Print Spooler Service seems to be disabled"
    }
    

    $ServerObject = [PSCustomObject] @{
        Servername       = $Env:ComputerName
        SpoolerIsRunning = $SpoolerIsRunning
        #IsPrintServer    = $false
        IsPrintServer    = $PrintMgmtInstalled
    }

    $ServerObject
}

function Disable-SpoolerIfNotPrintServer {
    param ($Device)

    $ServerObject = [PSCustomObject] @{
        Servername      = $Device.Servername
        SpoolerDisabled = $null
        IsPrintServer   = $Device.IsPrintServer
        Status          = $Null
    }

    ## Is it is a print server, we do not disable spooler
    if ($Device.IsPrintServer -eq $true) {
        $ServerObject.SpoolerDisabled = $False
        $ServerObject.Status = "Is print server, will not disable spooler"

        return $ServerObject
    }

    ## Disable spooler
    if ($Device.IsPrintServer -eq $false) {
        ## Server is not print server and is vulnerable

        try {
            Get-Service -Name Spooler -ea Stop | Stop-Service -PassThru -ea Stop | Set-Service -StartupType Disabled -ea Stop

            $ServerObject.SpoolerDisabled = $True
            $ServerObject.Status = "Disabled print spooler service"
        }
        catch {

            $SpoolerStatus = Get-Service -name Spooler | Select Status, StartType | fl

            $ServerObject.SpoolerDisabled = $SpoolerStatus
            $ServerObject.Status = $Error[0]
        }
    }

    return $ServerObject
}

## returns formatted status
Disable-SpoolerIfNotPrintServer -Device (Confirm-PrintSpoolerVulnerable) | Format-List